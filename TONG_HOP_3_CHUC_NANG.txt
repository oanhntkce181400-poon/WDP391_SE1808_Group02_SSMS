================================================================================
     Tá»”NG Há»¢P 3 CHá»¨C NÄ‚NG CHÃNH - SSMS PROJECT (PHIÃŠN Báº¢N RÃšT Gá»ŒN)
     1. Socket.IO   2. Cloudinary   3. Seed Data (Faker.js)
================================================================================

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 1. SOCKET.IO - REAL-TIME â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Œ Má»¤C ÄÃCH: Giao tiáº¿p real-time 2 chiá»u giá»¯a server-client, gá»­i notification/chat ngay láº­p tá»©c

ğŸ“Œ FILES:
   Backend: socket.config.js, socket.middleware.js, index.js
   Frontend: SocketContext.jsx, main.jsx
   Mobile: SocketContext.js, App.js

ğŸ“Œ LUá»’NG HOáº T Äá»˜NG:
   User login â†’ Nháº­n JWT token â†’ Client connect socket vá»›i token â†’ Server verify JWT
   â†’ LÆ°u userId vÃ o socket â†’ Join room "user:{userId}" â†’ Server cÃ³ thá»ƒ gá»­i message

ğŸ“Œ CODE BACKEND (socket.config.js):

const { Server } = require('socket.io');
const { socketAuthMiddleware } = require('../middlewares/socket.middleware');

function initializeSocketIO(httpServer) {
  const io = new Server(httpServer, {
    cors: { origin: '*', credentials: true, methods: ['GET', 'POST'] },
    pingTimeout: 60000, pingInterval: 25000,
  });

  io.use(socketAuthMiddleware); // JWT authentication

  io.on('connection', (socket) => {
    console.log(`ğŸ”Œ Socket: ${socket.id}, User: ${socket.email}`);
    socket.join(`user:${socket.userId}`); // Join room theo userId
    
    socket.emit('welcome', { message: 'Connected', userId: socket.userId });
    
    socket.on('disconnect', (reason) => {
      console.log(`âŒ Disconnected: ${reason}`);
    });
  });

  // Helper gá»­i message tá»›i user cá»¥ thá»ƒ
  io.sendToUser = (userId, event, data) => io.to(`user:${userId}`).emit(event, data);
  io.broadcastToAll = (event, data) => io.emit(event, data);

  return io;
}

ğŸ“Œ CODE MIDDLEWARE (socket.middleware.js):

function socketAuthMiddleware(socket, next) {
  try {
    const token = socket.handshake.auth?.token || socket.handshake.query?.token;
    if (!token) return next(new Error('No token provided'));

    const decoded = jwt.verify(token, process.env.JWT_ACCESS_SECRET);
    
    socket.userId = decoded.userId;
    socket.email = decoded.email;
    socket.role = decoded.role;
    
    next(); // Cho phÃ©p connect
  } catch (error) {
    next(new Error('Authentication error'));
  }
}

ğŸ“Œ CODE FRONTEND (SocketContext.jsx):

export const SocketProvider = ({ url, getToken, children }) => {
  const [socket, setSocket] = useState(null);
  const [isConnected, setIsConnected] = useState(false);

  useEffect(() => {
    const token = getToken?.();
    if (!token) return;

    const newSocket = io(url || 'http://localhost:3000', {
      auth: { token },
      transports: ['websocket', 'polling'],
      reconnection: true,
    });

    newSocket.on('connect', () => setIsConnected(true));
    newSocket.on('disconnect', () => setIsConnected(false));
    
    setSocket(newSocket);
    return () => newSocket.disconnect();
  }, [url, getToken]);

  return <SocketContext.Provider value={{ socket, isConnected }}>{children}</SocketContext.Provider>;
};

ğŸ“Œ Sá»¬ Dá»¤NG TRONG COMPONENT:

const { socket, isConnected } = useSocket();

useEffect(() => {
  if (!socket) return;
  socket.on('notification', (data) => console.log('New:', data));
  return () => socket.off('notification');
}, [socket]);

socket?.emit('send_message', { message: 'Hello' });

ğŸ“Œ TRáº Lá»œI THáº¦Y:
- Socket.IO hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o? 
  â†’ WebSocket 2 chiá»u, client gá»­i JWT khi handshake, server verify vÃ  lÆ°u user info vÃ o socket
- LÃ m sao báº£o máº­t? â†’ JWT authentication middleware, token háº¿t háº¡n = reject
- á»¨ng dá»¥ng? â†’ Notification real-time, chat, dashboard auto-update


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 2. CLOUDINARY - CLOUD STORAGE â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Œ Má»¤C ÄÃCH: Upload/delete áº£nh lÃªn cloud, tiáº¿t kiá»‡m server storage, auto optimize

ğŸ“Œ FILES: cloudinary.provider.js, .env (credentials)

ğŸ“Œ LUá»’NG:
   User chá»n áº£nh â†’ Frontend gá»­i file â†’ Multer lÆ°u táº¡m uploads/ â†’ uploadImage() 
   â†’ Cloudinary upload â†’ Tráº£ URL + public_id â†’ LÆ°u DB â†’ XÃ³a file táº¡m

ğŸ“Œ CODE (cloudinary.provider.js):

const cloudinary = require('cloudinary').v2;

cloudinary.config({
  cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
  api_key: process.env.CLOUDINARY_API_KEY,
  api_secret: process.env.CLOUDINARY_API_SECRET,
});

async function uploadImage(filePath, options = {}) {
  const result = await cloudinary.uploader.upload(filePath, {
    folder: 'ssms',
    resource_type: 'image',
    ...options,
  });
  
  return {
    url: result.url,
    secure_url: result.secure_url,
    public_id: result.public_id,
    width: result.width,
    height: result.height,
  };
}

async function deleteImage(publicId) {
  const result = await cloudinary.uploader.destroy(publicId);
  if (result.result === 'not found') throw new Error('Image not found');
  return result;
}

ğŸ“Œ Sá»¬ Dá»¤NG TRONG ROUTE:

const upload = multer({ dest: 'uploads/', limits: { fileSize: 5 * 1024 * 1024 } });

router.post('/avatar', upload.single('avatar'), async (req, res) => {
  const result = await uploadImage(req.file.path, { folder: 'avatars' });
  
  await User.findByIdAndUpdate(req.userId, {
    avatar: result.secure_url,
    avatarPublicId: result.public_id,
  });
  
  fs.unlinkSync(req.file.path); // XÃ³a file táº¡m
  res.json({ url: result.secure_url });
});

router.delete('/avatar', async (req, res) => {
  const user = await User.findById(req.userId);
  await deleteImage(user.avatarPublicId);
  await User.findByIdAndUpdate(req.userId, { avatar: null, avatarPublicId: null });
  res.json({ message: 'Deleted' });
});

ğŸ“Œ ENV:
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=123456789012345
CLOUDINARY_API_SECRET=abc123secret

Láº¥y táº¡i: https://console.cloudinary.com/ â†’ Dashboard

ğŸ“Œ TRáº¢ Lá»œI THáº¦Y:
- Cloudinary lÃ  gÃ¬? â†’ Cloud storage chuyÃªn áº£nh/video, cÃ³ CDN, auto optimize
- Táº¡i sao khÃ´ng lÆ°u server? â†’ Háº¿t dung lÆ°á»£ng nhanh, khÃ³ scale, khÃ´ng tá»± optimize
- Upload nhÆ° tháº¿ nÃ o? â†’ Multer nháº­n file â†’ uploadImage() â†’ LÆ°u URL + public_id vÃ o DB
- XÃ³a áº£nh? â†’ deleteImage(public_id)


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 3. SEED DATA Vá»šI FAKER.JS â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Œ Má»¤C ÄÃCH: Generate fake data (1000 students, 100 teachers) Ä‘á»ƒ test

ğŸ“Œ FILE: backend-api/src/database/seeds/index.js

ğŸ“Œ LUá»’NG:
   npm run seed â†’ Connect MongoDB â†’ XÃ³a data cÅ© â†’ Seed Majors â†’ Subjects â†’ Curriculums
   â†’ Rooms â†’ Devices â†’ Teachers â†’ Students â†’ Admin user â†’ Done

ğŸ“Œ CODE QUAN TRá»ŒNG:

const { fakerVI } = require('@faker-js/faker');
const faker = fakerVI;
faker.seed(20250127); // Fixed seed

const MAJORS = [
  { code: 'CE', name: 'CÃ´ng nghá»‡ thÃ´ng tin' },
  { code: 'SE', name: 'Ká»¹ thuáº­t pháº§n má»m' },
  { code: 'BA', name: 'Kinh táº¿' },
  { code: 'CA', name: 'Thiáº¿t káº¿ Ä‘á»“ há»a' },
];

// Generate email: tuanasce190001@fpt.edu.vn
function buildStudentEmail(fullName, majorCode, cohort, suffixNumber) {
  const parts = fullName.trim().split(/\s+/);
  const firstName = normalizeText(parts[parts.length - 1]); // "tuáº¥n" â†’ "tuan"
  const initials = normalizeText(parts.slice(0, -1).map(p => p[0]).join('')); // "na"
  return `${firstName}${initials}${majorCode.toLowerCase()}${cohort}${String(suffixNumber).padStart(4, '0')}@fpt.edu.vn`;
}

// Generate mÃ£ SV: SE190001
function buildStudentCode(majorCode, cohort, suffix) {
  return `${majorCode}${cohort}${String(suffix).padStart(4, '0')}`;
}

function normalizeText(text) {
  return text.normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/[^a-zA-Z]/g, '').toLowerCase();
}

// Seed 1000 students
async function seedStudents(curriculums) {
  const students = [];
  const suffixCounters = new Map();

  for (let i = 0; i < 1000; i++) {
    const major = randomFrom(MAJORS);
    const cohort = randomFrom([16, 17, 18, 19, 20]);
    const fullName = faker.person.fullName();
    const suffix = (suffixCounters.get(`${major.code}-${cohort}`) || 999) + 1;
    suffixCounters.set(`${major.code}-${cohort}`, suffix);

    students.push({
      studentCode: buildStudentCode(major.code, cohort, suffix),
      fullName,
      email: buildStudentEmail(fullName, major.code, cohort, suffix),
      majorCode: major.code,
      cohort,
      curriculum: curriculums.find(c => c.cohort === cohort)._id,
    });
  }

  await Student.insertMany(students, { ordered: false });
}

// Seed 50 subjects
async function seedSubjects() {
  const subjects = [];
  for (let i = 0; i < 50; i++) {
    subjects.push({
      subjectCode: `SUB${String(i+1).padStart(3, '0')}`,
      subjectName: `${faker.hacker.noun()} ${faker.hacker.verb()}`,
      credits: faker.number.int({ min: 2, max: 5 }),
      majorCode: randomFrom(MAJORS).code,
    });
  }
  return Subject.insertMany(subjects);
}

// Seed admin
async function seedAdmin() {
  const hashedPwd = await bcrypt.hash('123456', 10);
  const exists = await User.findOne({ email: 'admin@example.com' });
  if (!exists) {
    await User.create({
      email: 'admin@example.com',
      password: hashedPwd,
      fullName: 'System Admin',
      role: 'admin',
    });
  }
}

// Main seed
async function seed() {
  await connectDB();
  await Promise.all([Student.deleteMany({}), Teacher.deleteMany({}), ...]);
  
  await seedMajors();
  const subjects = await seedSubjects();
  const curriculums = await seedCurriculums(subjects);
  const rooms = await seedRooms();
  
  await Promise.all([seedDevices(rooms), seedTeachers(), seedStudents(curriculums)]);
  await seedAdmin();
  
  console.log('âœ… Seeding completed');
}

seed().then(() => process.exit(0)).catch(err => { console.error(err); process.exit(1); });

ğŸ“Œ Káº¾T QUáº¢:
âœ… 4 majors, 50 subjects, 5 curriculums (K16-K20), 50 rooms, 200 devices
âœ… 100 teachers, 1000 students
âœ… Admin: admin@example.com / 123456

ğŸ“Œ TRáº¢ Lá»œI THáº¦Y:
- Seed data nhÆ° tháº¿ nÃ o? â†’ Script dÃ¹ng Faker.js generate tÃªn/email giá»‘ng tháº­t
- Táº¡i sao cáº§n seed? â†’ Test pagination/search/filter vá»›i data lá»›n, khÃ´ng nháº­p tay
- Email format? â†’ firstname + initials + major + cohort + sá»‘ (tuanasce190001@fpt.edu.vn)
- Faker.js lÃ  gÃ¬? â†’ ThÆ° viá»‡n generate fake data realistic, em dÃ¹ng fakerVI (tiáº¿ng Viá»‡t)


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” Tá»”NG Káº¾T â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CHá»¨C NÄ‚NG   â”‚ TÃ“M Táº®T                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Socket.IO   â”‚ Real-time 2-way, JWT auth, gá»­i notification/chat ngay   â”‚
â”‚ Cloudinary  â”‚ Cloud storage áº£nh, auto optimize, CDN, lÆ°u URL+publicID â”‚
â”‚ Seed Data   â”‚ Faker.js generate 1000 students, test vá»›i data lá»›n      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” COMMANDS & CONFIG â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# Backend
cd backend-api
npm install                    # socket.io, cloudinary, @faker-js/faker, multer, bcryptjs, jsonwebtoken
npm run seed                   # Cháº¡y seed data
npm start                      # Start server + Socket.IO

# Frontend
cd frontend-web
npm install                    # socket.io-client
npm run dev

# .env
MONGODB_URI=mongodb://localhost:27017/ssms
JWT_ACCESS_SECRET=your-secret
CLOUDINARY_CLOUD_NAME=name
CLOUDINARY_API_KEY=key
CLOUDINARY_API_SECRET=secret
CORS_ORIGINS=http://localhost:3000,http://localhost:5173
PORT=5000

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” TESTING â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ§ª Socket.IO: F12 â†’ Console â†’ Check "Socket connected" log â†’ Test: socket.emit('ping')
ğŸ§ª Cloudinary: Postman POST /api/users/avatar (form-data: avatar=file) â†’ Check URL response
ğŸ§ª Seed Data: npm run seed â†’ Check logs â†’ MongoDB Compass count documents

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” LÆ¯U Ã â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸  Socket: Token háº¿t háº¡n = auto disconnect, pháº£i cÃ³ JWT há»£p lá»‡
âš ï¸  Cloudinary: KHÃ”NG commit .env, free tier 25GB/thÃ¡ng
âš ï¸  Seed: XÃ“A toÃ n bá»™ data cÅ©, chá»‰ cháº¡y trÃªn local/dev DB

================================================================================
ğŸ“… 28/01/2026 | WDP391_SE1808_Group02_SSMS | ğŸš€ Good luck!
